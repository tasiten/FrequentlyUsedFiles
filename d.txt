require 'aws-sdk-cloudwatch'
require 'csv'
require 'date'

# CloudWatch クライアントを作成。サービス名と地域を指定する必要がある。
cloudwatch = Aws::CloudWatch::Client.new(region: 'ap-northeast-1')

# メトリクス情報
namespace = 'AWS/RDS'
metricname = 'CPUUtilization'
dimensions_name = 'DBInstanceIdentifier'
dimensions_value = 'biz3-loadtest-db01'
period = 300  # 1分ごとのデータ
stat = 'Average' # 平均モードでデータ取得
start_time = "2023-09-20-17-00-00" # データ取得範囲開始時刻(年-月-日-時-分-秒)
end_time = "2023-09-20-18-00-00" # データ取得範囲終了時刻(年-月-日-時-分-秒)

# 指定した期間のデータポイントを取得
response = cloudwatch.get_metric_data({
  metric_data_queries: [
    {
      id: 'm1',
      metric_stat: {
        metric: {
          namespace: namespace,
          metric_name: metricname,
          dimensions: [
            {
              name: dimensions_name,
              value: dimensions_value
            }
          ]
        },
        period: period,
        stat: stat
      },
      return_data: true
    }
  ],
  start_time: DateTime.strptime(start_time, '%Y-%m-%d-%H-%M-%S'),
  end_time: DateTime.strptime(end_time, '%Y-%m-%d-%H-%M-%S')
})

# 取得したデータポイントを表示、CSV出力
CSV.open("#{metricname}.csv", 'wb') do |csv|
  csv << ["Time", "Value"]
  response.metric_data_results.each do |metric_result|
    metric_result.timestamps.zip(metric_result.values).reverse_each do |time, value|
      puts "Time: #{time}, Value: #{value}"
      csv << [time, value]
    end
  end
end
